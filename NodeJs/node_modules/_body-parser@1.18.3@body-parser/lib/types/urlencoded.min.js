/*!
 * body-parser
 * Copyright(c) 2014 Jonathan Ong
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */
;"use strict";var bytes=require("bytes");var contentType=require("content-type");var createError=require("http-errors");var debug=require("debug")("body-parser:urlencoded");var deprecate=require("depd")("body-parser");var read=require("../read");var typeis=require("type-is");module.exports=urlencoded;var parsers=Object.create(null);function urlencoded(k){var a=k||{};if(a.extended===undefined){deprecate("undefined extended: provide extended option")}var e=a.extended!==false;var i=a.inflate!==false;var d=typeof a.limit!=="number"?bytes.parse(a.limit||"100kb"):a.limit;var f=a.type||"application/x-www-form-urlencoded";var g=a.verify||false;if(g!==false&&typeof g!=="function"){throw new TypeError("option verify must be function")}var b=e?extendedparser(a):simpleparser(a);var j=typeof f!=="function"?typeChecker(f):f;function c(l){return l.length?b(l):{}}return function h(n,l,m){if(n._body){debug("body already parsed");m();return}n.body=n.body||{};if(!typeis.hasBody(n)){debug("skip empty body");m();return}debug("content-type %j",n.headers["content-type"]);if(!j(n)){debug("skip parsing");m();return}var o=getCharset(n)||"utf-8";if(o!=="utf-8"){debug("invalid charset");m(createError(415,'unsupported charset "'+o.toUpperCase()+'"',{charset:o,type:"charset.unsupported"}));return}read(n,l,m,c,debug,{debug:debug,encoding:o,inflate:i,limit:d,verify:g})}}function extendedparser(a){var c=a.parameterLimit!==undefined?a.parameterLimit:1000;var b=parser("qs");if(isNaN(c)||c<1){throw new TypeError("option parameterLimit must be a positive number")}if(isFinite(c)){c=c|0}return function d(f){var g=parameterCount(f,c);if(g===undefined){debug("too many parameters");throw createError(413,"too many parameters",{type:"parameters.too.many"})}var e=Math.max(100,g);debug("parse extended urlencoding");return b(f,{allowPrototypes:true,arrayLimit:e,depth:Infinity,parameterLimit:c})}}function getCharset(a){try{return(contentType.parse(a).parameters.charset||"").toLowerCase()}catch(b){return undefined}}function parameterCount(a,b){var d=0;var c=0;while((c=a.indexOf("&",c))!==-1){d++;c++;if(d===b){return undefined}}return d}function parser(a){var b=parsers[a];if(b!==undefined){return b.parse}switch(a){case"qs":b=require("qs");break;case"querystring":b=require("querystring");break}parsers[a]=b;return b.parse}function simpleparser(a){var c=a.parameterLimit!==undefined?a.parameterLimit:1000;var b=parser("querystring");if(isNaN(c)||c<1){throw new TypeError("option parameterLimit must be a positive number")}if(isFinite(c)){c=c|0}return function d(e){var f=parameterCount(e,c);if(f===undefined){debug("too many parameters");throw createError(413,"too many parameters",{type:"parameters.too.many"})}debug("parse urlencoding");return b(e,undefined,undefined,{maxKeys:c})}}function typeChecker(b){return function a(c){return Boolean(typeis(c,b))}};