/*!
 * body-parser
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */
;"use strict";var createError=require("http-errors");var getBody=require("raw-body");var iconv=require("iconv-lite");var onFinished=require("on-finished");var zlib=require("zlib");module.exports=read;function read(j,h,g,f,b,l){var d;var a=l;var k;j._body=true;var c=a.encoding!==null?a.encoding:null;var i=a.verify;try{k=contentstream(j,b,a.inflate);d=k.length;k.length=undefined}catch(e){return g(e)}a.length=d;a.encoding=i?null:c;if(a.encoding===null&&c!==null&&!iconv.encodingExists(c)){return g(createError(415,'unsupported charset "'+c.toUpperCase()+'"',{charset:c.toLowerCase(),type:"charset.unsupported"}))}b("read body");getBody(k,a,function(o,m){if(o){var r;if(o.type==="encoding.unsupported"){r=createError(415,'unsupported charset "'+c.toUpperCase()+'"',{charset:c.toLowerCase(),type:"charset.unsupported"})}else{r=createError(400,o)}k.resume();onFinished(j,function n(){g(createError(400,r))});return}if(i){try{b("verify body");i(j,h,m,c)}catch(p){g(createError(403,p,{body:m,type:p.type||"entity.verify.failed"}));return}}var q=m;try{b("parse body");q=typeof m!=="string"&&c!==null?iconv.decode(m,c):m;j.body=f(q)}catch(p){g(createError(400,p,{body:q,type:p.type||"entity.parse.failed"}));return}g()})}function contentstream(d,a,f){var c=(d.headers["content-encoding"]||"identity").toLowerCase();var b=d.headers["content-length"];var e;a('content-encoding "%s"',c);if(f===false&&c!=="identity"){throw createError(415,"content encoding unsupported",{encoding:c,type:"encoding.unsupported"})}switch(c){case"deflate":e=zlib.createInflate();a("inflate body");d.pipe(e);break;case"gzip":e=zlib.createGunzip();a("gunzip body");d.pipe(e);break;case"identity":e=d;e.length=b;break;default:throw createError(415,'unsupported content encoding "'+c+'"',{encoding:c,type:"encoding.unsupported"})}return e};